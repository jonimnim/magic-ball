require('dotenv').config();
const { Telegraf } = require('telegraf');
const { getMagicAnswer } = require('./magicAnswer');

const TELEGRAM_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
if (!TELEGRAM_TOKEN || !DEEPSEEK_API_KEY) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ TELEGRAM_BOT_TOKEN Ð¸Ð»Ð¸ DEEPSEEK_API_KEY Ð² .env Ñ„Ð°Ð¹Ð»Ðµ');
    process.exit(1);
}

const bot = new Telegraf(TELEGRAM_TOKEN);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð±Ð¾Ñ‚Ð°
bot.start((ctx) => {
    ctx.reply(`ðŸ”® *ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ ÐœÐ°Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¨Ð°Ñ€ Ð¡ÑƒÐ´ÑŒÐ±Ñ‹* 

Ð—Ð°Ð´Ð°Ð¹ Ð¼Ð½Ðµ Ð»ÑŽÐ±Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð¸ Ñ Ð¾Ñ‚Ð²ÐµÑ‡Ñƒ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ð¸ Ð·Ð°Ð³Ð°Ð´Ð¾Ñ‡Ð½Ð¾!

*ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²:*
â€¢ Ð¡Ñ‚Ð¾Ð¸Ñ‚ Ð»Ð¸ Ð¼Ð½Ðµ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚?
â€¢ ÐŸÐ¾Ð»ÑƒÑ‡Ñƒ Ð»Ð¸ Ñ Ð¿Ð¾Ð²Ñ‹ÑˆÐµÐ½Ð¸Ðµ?
â€¢ Ð¡Ñ‚Ð¾Ð¸Ñ‚ Ð»Ð¸ Ð´Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ ÑÑ‚Ð¾Ð¼Ñƒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÑƒ?
â€¢ Ð–Ð´Ð°Ñ‚ÑŒ Ð»Ð¸ Ð¼Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² Ð¶Ð¸Ð·Ð½Ð¸?

*ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ ÑÐ²Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ...*`, { parse_mode: 'Markdown' });
});

bot.help((ctx) => {
    ctx.reply(`ðŸ’« *ÐšÐ°Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð¼Ð°Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ ÑˆÐ°Ñ€Ð¾Ð¼:*

1. Ð—Ð°Ð´Ð°Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ¼, Ñ€ÐµÑˆÐµÐ½Ð¸ÑÑ… Ð¸Ð»Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑÑ…
2. Ð¯ Ð¾Ñ‚Ð²ÐµÑ‡Ñƒ Ð¾Ð´Ð½Ð¸Ð¼-Ñ‚Ñ€ÐµÐ¼Ñ ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸
3. Ð˜Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð¸Ñ€ÑƒÐ¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¸Ð½Ñ‚ÑƒÐ¸Ñ‚Ð¸Ð²Ð½Ð¾!

*ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:* 
âœ… Ð´Ð°, Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð´ÐµÑ€Ð·Ð°Ð¹, Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚, Ð²ÐµÑ€ÑŒ Ð² ÑÐµÐ±Ñ
âŒ Ð½ÐµÑ‚, Ð¼Ð°Ð»Ð¾Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾, Ð½Ðµ ÑÐµÐ¹Ñ‡Ð°Ñ, Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½ÐµÐµ

*Ð—Ð°Ð´Ð°Ð²Ð°Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ñ Ð²ÐµÑ€Ð¾Ð¹ Ð² Ð¼Ð°Ð³Ð¸ÑŽ!* ðŸ”®`, { parse_mode: 'Markdown' });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²ÑÐµÑ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async (ctx) => {
    const question = ctx.message.text;
    
    // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
    if (question.startsWith('/')) return;
    
    try {
        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ "Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚"
        await ctx.sendChatAction('typing');
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ Ð¼Ð°Ð³Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑˆÐ°Ñ€Ð°
        const answer = await getMagicAnswer(question);
        
        // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚
        const formattedAnswer = `ðŸ”® *Ð¢Ð²Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ:* ${question}\n\nâœ¨ *ÐžÑ‚Ð²ÐµÑ‚ ÑÑƒÐ´ÑŒÐ±Ñ‹:* ${answer}`;
        
        await ctx.reply(formattedAnswer, { parse_mode: 'Markdown' });
        
    } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð¾Ñ‚Ð°:', error);
        await ctx.reply('âš ï¸ ÐœÐ°Ð³Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°... ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ');
    }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Telegraf:', err);
    ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¼Ð°Ð³Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°...');
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð¼Ð°Ð³Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼ Ð±Ð¾Ñ‚Ð°...');
bot.launch().then(() => {
    console.log('âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
});

// ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));